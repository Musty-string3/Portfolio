<div class="offset-lg-2 col-lg-4">
  <h4 style="text-align: center;">入力欄</h4>
  <%= form_with model: post, html: {onsubmit: "return validateForm()"} do |f| %>
    <%= f.label :images, "画像(6枚まで投稿可)" %>
    <%= f.file_field :images, accept: "image/*", multiple: true, onchange: "loadImage(this)" %>
    <div class="text-danger">
      <span class="post_images_error d-none">ファイルは1から6枚まで</span>
    </div>
    <br>
    <div class="form-group">
      <%= f.label :post_name, "投稿名" %>
      <div>
        <span><%= f.text_field :post_name, class: "form-control valid-check" %></span>
        <p class="error_message_post_name">投稿名を入力してください。</p>
      </div>
      <p class="ok_message_post_name">OK</p>
    </div>
    <div class="form-group">
      <%= f.label :explanation, "投稿の説明" %>
      <%= f.text_area :explanation, class: "form-control valid-check" %>
    </div>

    <div class="form-group">
      <%= f.label :tag, "タグ (、で区切ると複数タグ登録できます)" %>
      <%= f.text_field :tag, placeholder: "タグを入力", class: "form-control" %>
    </div>
    <br>
    <%= f.submit "投稿する", id: "submit-btn", class:"btn btn-outline-info" %>
  <% end %>
</div>
<div class="col-lg-4">
  <h4 style="text-align: center;">入力内容</h4>
  <p>投稿画像：</p>
  <div id="preview"></div>
  <div id="error_message_post_image" class="text-danger"></div>
  <p>投稿名：<span id="check_post_name"></span></p>
</div>


<script>

  // ref: https://blog.ver001.com/javascript-image-preview-multiple/
  
  // 投稿画像入力時に画面に画像を表示する
  function loadImage(obj){
    let fileReader;
    $('#preview').empty();  // previewの中身を全消去(empty)する
    $("#error_message_post_image").empty();
    if (obj.files.length > 6) {
      $("#error_message_post_image").html("画像は6枚以下で指定してください");
      return false;  //breakのようなもの
    }
  	for (i = 0; i < obj.files.length; i++) {
  		fileReader = new FileReader();
  		fileReader.onload = (function (e) {
  		  // idがpreviewを探し、その箇所に要素を追加(append)していく
  			$('#preview').append('<img class="m-1 preview_img" src="' + e.target.result + '">');
  		});
  		fileReader.readAsDataURL(obj.files[i]);
  	}
  }

  // 投稿名入力時に値を取得し、画面に1文字ずつ表示する
  const name = $("#post_post_name");
  name.on("input", function() {
    $("#check_post_name").text(name.val());
  });

  // バリエーションエラー表示
  function validateForm() {
    // バリデーションエラーフラグ初期値
    let validateErrorFlg = false;

    // ファイルの選択バリデーション
    const postImages = $("#post_images")
    const postImagesError = $(".post_images_error")
    if (postImages.prop('files').length > 6 || postImages.prop('files').length === 0) {
      validateErrorFlg = true;
      postImagesError.removeClass('d-none');
      postImagesError.addClass('d-block');
    } else {
      postImagesError.removeClass('d-block');
      postImagesError.addClass('d-none');
    }

    changeValidClass($("#post_post_name")); // フォームチェック
    changeValidClass($("#post_explanation")); // フォームチェック

    // 対象のフォームにis-invalidが付与されていれば、
    // バリデーションエラーありと判定する
    $(".valid-check").each( function() {
      if ($(this).hasClass("is-invalid")) {
        validateErrorFlg = true; // フラグ上書き
      }
    });

    if (validateErrorFlg) {
      // submitボタンを再度有効化
      $.ajax({}).done(function() { $("#submit-btn").prop("disabled", false); })
      return false; // 送信処理中断
    }
  }

  // バリデーションチェックする入力欄のclass制御
  $(".valid-check").on("blur input", function () {
    changeValidClass($(this));
  })

  // バリデーションチェック結果に応じてclassを変更する
  // TODO toggleClass()使えないか？
  function changeValidClass(elem) {
    if (elem.val() === "") {
      elem.removeClass("is-valid");
      elem.addClass("is-invalid");
    } else {
      elem.removeClass("is-invalid");
      elem.addClass("is-valid");
    }
  }

</script>

<!--const text = $("#post_post_name");-->
<!--text.on("input", function() {-->
<!--  $(this).blur(function(){-->
<!--    $("#post_name").text(text.val());-->
<!--  });-->
<!--});-->